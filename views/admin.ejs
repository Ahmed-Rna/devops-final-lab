<%- include('partials/header', { title: 'Admin Panel' }) %>

<main class="admin-page">
  <div class="container">
    <h1>Admin Panel</h1>

    <div class="admin-section">
      <h2>Add New Medicine</h2>
      <form id="add-medicine-form" class="medicine-form">
        <div class="form-group">
          <label for="name">Medicine Name:</label>
          <input type="text" id="name" name="name" required>
        </div>

        <div class="form-group">
          <label for="description">Description:</label>
          <textarea id="description" name="description" rows="3"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="price">Price ($):</label>
            <input type="number" id="price" name="price" step="0.01" min="0" required>
          </div>

          <div class="form-group">
            <label for="stock">Stock:</label>
            <input type="number" id="stock" name="stock" min="0" required>
          </div>
        </div>

        <div class="form-group">
          <label for="category">Category:</label>
          <select id="category" name="category">
            <option value="General">General</option>
            <option value="Painkiller">Painkiller</option>
            <option value="Antibiotic">Antibiotic</option>
            <option value="Vitamin">Vitamin</option>
            <option value="Supplement">Supplement</option>
          </select>
        </div>

        <div class="form-group">
          <label for="image_url">Image URL:</label>
          <input type="url" id="image_url" name="image_url">
        </div>

        <button type="submit" class="btn btn-primary">Add Medicine</button>
      </form>

      <div id="message" class="message"></div>
    </div>

    <div class="admin-section">
      <h2>Manage Medicines</h2>
      <div id="medicines-list" class="medicines-grid"></div>
    </div>
  </div>
</main>

<script>
  async function loadMedicines() {
    try {
      const response = await fetch('/api/medicines');
      const data = await response.json();

      const container = document.getElementById('medicines-list');
      container.innerHTML = '';

      if (data.success && data.data.length > 0) {
        data.data.forEach(medicine => {
          const card = document.createElement('div');
          card.className = 'medicine-card';
          card.innerHTML = `
            ${medicine.image_url ? `<img src="${medicine.image_url}" alt="${medicine.name}">` : ''}
            <h3>${medicine.name}</h3>
            <p>${medicine.description}</p>
            <p><strong>Price:</strong> $${medicine.price}</p>
            <p><strong>Stock:</strong> ${medicine.stock}</p>
            <p><strong>Category:</strong> ${medicine.category}</p>
            <button onclick="deleteMedicine('${medicine._id}')" class="btn btn-danger">Delete</button>
          `;
          container.appendChild(card);
        });
      } else {
        container.innerHTML = '<p>No medicines found. Add some medicines to get started.</p>';
      }
    } catch (error) {
      console.error('Error loading medicines:', error);
    }
  }

  async function deleteMedicine(id) {
    if (!confirm('Are you sure you want to delete this medicine?')) return;

    try {
      const response = await fetch(`/api/medicines/${id}`, {
        method: 'DELETE'
      });
      const data = await response.json();

      if (data.success) {
        showMessage('Medicine deleted successfully', 'success');
        loadMedicines();
      } else {
        showMessage('Error deleting medicine', 'error');
      }
    } catch (error) {
      showMessage('Error deleting medicine', 'error');
    }
  }

  document.getElementById('add-medicine-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
      name: document.getElementById('name').value,
      description: document.getElementById('description').value,
      price: parseFloat(document.getElementById('price').value),
      stock: parseInt(document.getElementById('stock').value),
      category: document.getElementById('category').value,
      image_url: document.getElementById('image_url').value
    };

    try {
      const response = await fetch('/api/medicines', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
      });

      const data = await response.json();

      if (data.success) {
        showMessage('Medicine added successfully!', 'success');
        e.target.reset();
        loadMedicines();
      } else {
        showMessage('Error adding medicine', 'error');
      }
    } catch (error) {
      showMessage('Error adding medicine', 'error');
    }
  });

  function showMessage(text, type) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = text;
    messageDiv.className = `message ${type}`;
    messageDiv.style.display = 'block';

    setTimeout(() => {
      messageDiv.style.display = 'none';
    }, 3000);
  }

  loadMedicines();
</script>

<%- include('partials/footer') %>
